{% extends "base.html" %}

{% block title %}Your Personalized Content - News Hub{% endblock %}

{% block content %}
<!-- Loading State -->
<div id="loadingContent" class="text-center py-5">
    <div class="spinner-border text-primary mb-3" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
    <h4>Generating Your Personalized Content</h4>
    <p class="text-muted">Our AI is analyzing your selected articles and creating unique content just for you...</p>
</div>

<!-- Content Display -->
<div id="contentDisplay" style="display: none;">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2><i class="fas fa-magic me-2 text-primary"></i>Your Personalized Content</h2>
                    <p class="text-muted mb-0">
                        <i class="fas fa-robot me-1"></i>Generated by Gemini AI |
                        <i class="fas fa-clock me-1"></i><span id="generationTime"></span>
                    </p>
                </div>
                <div>
                    <div class="btn-group">
                        <button class="btn btn-outline-primary" id="shareBtn">
                            <i class="fas fa-share-alt me-2"></i>Share
                        </button>
                        <button class="btn btn-outline-success" id="downloadBtn">
                            <i class="fas fa-download me-2"></i>Download
                        </button>
                        <a href="/news-feed" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Back to Articles
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Content Statistics -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-light">
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <div class="h4 text-primary mb-1" id="articlesCount">0</div>
                            <div class="text-muted small">Articles Analyzed</div>
                        </div>
                        <div class="col-md-3">
                            <div class="h4 text-success mb-1" id="wordsCount">0</div>
                            <div class="text-muted small">Words Generated</div>
                        </div>
                        <div class="col-md-3">
                            <div class="h4 text-info mb-1" id="readingTime">0</div>
                            <div class="text-muted small">Min Read Time</div>
                        </div>
                        <div class="col-md-3">
                            <div class="h4 text-warning mb-1">
                                <i class="fas fa-star"></i>
                            </div>
                            <div class="text-muted small">AI Generated</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div id="generatedContent" class="content-area">
                        <!-- AI-generated content will be displayed here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="row mt-4">
        <div class="col-12 text-center">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h5><i class="fas fa-thumbs-up me-2"></i>What's Next?</h5>
                    <div class="row mt-3">
                        <div class="col-md-4 mb-2">
                            <a href="/" class="btn btn-light btn-lg w-100">
                                <i class="fas fa-plus me-2"></i>Create New Content
                            </a>
                        </div>
                        <div class="col-md-4 mb-2">
                            <button class="btn btn-outline-light btn-lg w-100" id="regenerateBtn">
                                <i class="fas fa-redo me-2"></i>Regenerate Content
                            </button>
                        </div>
                        <div class="col-md-4 mb-2">
                            <button class="btn btn-outline-light btn-lg w-100" id="feedbackBtn">
                                <i class="fas fa-heart me-2"></i>Give Feedback
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Error State -->
<div id="errorState" style="display: none;">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card border-danger">
                <div class="card-body text-center py-5">
                    <i class="fas fa-exclamation-triangle fa-4x text-danger mb-3"></i>
                    <h4>Content Generation Failed</h4>
                    <p class="text-muted mb-4" id="errorMessage">
                        We encountered an issue while generating your personalized content.
                    </p>
                    <div class="d-grid gap-2 d-md-block">
                        <a href="/news-feed" class="btn btn-primary">
                            <i class="fas fa-arrow-left me-2"></i>Back to Articles
                        </a>
                        <button class="btn btn-outline-secondary" id="retryBtn">
                            <i class="fas fa-redo me-2"></i>Try Again
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Feedback Modal -->
<div class="modal fade" id="feedbackModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-heart me-2"></i>How was your experience?
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Rate the content quality:</label>
                    <div class="btn-group w-100" role="group">
                        <input type="radio" class="btn-check" name="rating" id="rating1" value="1">
                        <label class="btn btn-outline-warning" for="rating1">⭐</label>
                        <input type="radio" class="btn-check" name="rating" id="rating2" value="2">
                        <label class="btn btn-outline-warning" for="rating2">⭐⭐</label>
                        <input type="radio" class="btn-check" name="rating" id="rating3" value="3">
                        <label class="btn btn-outline-warning" for="rating3">⭐⭐⭐</label>
                        <input type="radio" class="btn-check" name="rating" id="rating4" value="4">
                        <label class="btn btn-outline-warning" for="rating4">⭐⭐⭐⭐</label>
                        <input type="radio" class="btn-check" name="rating" id="rating5" value="5">
                        <label class="btn btn-outline-warning" for="rating5">⭐⭐⭐⭐⭐</label>
                    </div>
                </div>
                <div class="mb-3">
                    <label for="feedbackText" class="form-label">Additional feedback:</label>
                    <textarea class="form-control" id="feedbackText" rows="3"
                              placeholder="Tell us what you liked or how we can improve..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="submitFeedback">Submit Feedback</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
.content-area {
    line-height: 1.8;
    font-size: 1.1rem;
}

.content-area h1, .content-area h2, .content-area h3 {
    color: #2c3e50;
    margin-top: 2rem;
    margin-bottom: 1rem;
}

.content-area h1 {
    border-bottom: 3px solid #007bff;
    padding-bottom: 0.5rem;
}

.content-area h2 {
    border-left: 4px solid #28a745;
    padding-left: 1rem;
}

.content-area p {
    margin-bottom: 1.5rem;
    text-align: justify;
}

.content-area ul, .content-area ol {
    margin-bottom: 1.5rem;
    padding-left: 2rem;
}

.content-area li {
    margin-bottom: 0.5rem;
}

.content-area blockquote {
    border-left: 4px solid #6c757d;
    padding-left: 1rem;
    margin: 1.5rem 0;
    font-style: italic;
    background-color: #f8f9fa;
    padding: 1rem;
    border-radius: 0.25rem;
}

@media print {
    .btn, .card-header, .modal, .navbar {
        display: none !important;
    }

    .content-area {
        font-size: 12pt;
        line-height: 1.6;
    }
}
</style>

<script>
$(document).ready(function() {
    let generatedData = null;

    // Load generated content from session storage
    loadContent();

    // Event listeners
    $('#shareBtn').click(shareContent);
    $('#downloadBtn').click(downloadContent);
    $('#regenerateBtn').click(regenerateContent);
    $('#feedbackBtn').click(() => $('#feedbackModal').modal('show'));
    $('#submitFeedback').click(submitFeedback);
    $('#retryBtn').click(() => window.location.href = '/news-feed');

    function loadContent() {
        try {
            const storedData = sessionStorage.getItem('generatedContent');
            if (storedData) {
                generatedData = JSON.parse(storedData);
                displayContent(generatedData);
            } else {
                showError('No content data found. Please select articles first.');
            }
        } catch (error) {
            showError('Failed to load content data.');
        }
    }

    function displayContent(data) {
        if (data.status === 'success') {
            // Update statistics
            $('#articlesCount').text(data.articles_count || 0);
            $('#generationTime').text(new Date().toLocaleString());

            // Process and display content
            let content = data.content || '';

            // Convert markdown-style formatting to HTML
            content = formatContent(content);

            $('#generatedContent').html(content);

            // Calculate statistics
            const wordCount = content.split(/\s+/).length;
            const readingTime = Math.ceil(wordCount / 200); // Average reading speed

            $('#wordsCount').text(wordCount);
            $('#readingTime').text(readingTime);

            // Show content
            $('#loadingContent').hide();
            $('#contentDisplay').show();

        } else {
            showError(data.message || 'Content generation failed');

            // Show fallback content if available
            if (data.fallback_content) {
                $('#generatedContent').html(formatContent(data.fallback_content));
                $('#contentDisplay').show();
            }
        }
    }

    function formatContent(content) {
        // Basic markdown to HTML conversion
        content = content
            .replace(/^# (.*$)/gm, '<h1>$1</h1>')
            .replace(/^## (.*$)/gm, '<h2>$1</h2>')
            .replace(/^### (.*$)/gm, '<h3>$1</h3>')
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.*?)\*/g, '<em>$1</em>')
            .replace(/^\* (.*$)/gm, '<li>$1</li>')
            .replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>')
            .replace(/\n\n/g, '</p><p>')
            .replace(/^(?!<[hul])/gm, '<p>')
            .replace(/(?<![hul]>)$/gm, '</p>');

        return content;
    }

    function showError(message) {
        $('#loadingContent').hide();
        $('#errorMessage').text(message);
        $('#errorState').show();
    }

    function shareContent() {
        if (navigator.share && generatedData) {
            navigator.share({
                title: 'My Personalized News Content',
                text: 'Check out this personalized news content generated by AI!',
                url: window.location.href
            });
        } else {
            // Fallback: copy to clipboard
            navigator.clipboard.writeText(window.location.href).then(() => {
                alert('Link copied to clipboard!');
            });
        }
    }

    function downloadContent() {
        if (!generatedData) return;

        const content = generatedData.content || '';
        const blob = new Blob([content], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `personalized-news-${new Date().toISOString().split('T')[0]}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    function regenerateContent() {
        if (confirm('Are you sure you want to regenerate the content? This will replace the current content.')) {
            // Go back to news feed to regenerate
            window.location.href = '/news-feed';
        }
    }

    function submitFeedback() {
        const rating = $('input[name="rating"]:checked').val();
        const feedback = $('#feedbackText').val().trim();

        if (!rating) {
            alert('Please provide a rating.');
            return;
        }

        // Here you could send feedback to your backend
        console.log('Feedback submitted:', { rating, feedback });

        $('#feedbackModal').modal('hide');
        alert('Thank you for your feedback!');

        // Reset form
        $('input[name="rating"]').prop('checked', false);
        $('#feedbackText').val('');
    }
});
</script>
{% endblock %}
